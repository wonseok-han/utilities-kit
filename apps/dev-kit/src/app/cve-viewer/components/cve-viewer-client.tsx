'use client';

import { useInfiniteScroll } from '@hooks';
import { ActionButton, useSnackbar } from '@repo/ui';
import { useCVEStore } from '@store';
import React, { useEffect } from 'react';

import { CVECard, CVECardSkeleton } from './index';

interface CVEViewerClientProps {
  initialCVEs: CVEDataType[];
  metadata: PaginationType;
}

/**
 * CVE Viewer í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ - ë°ì´í„°ê°€ í•„ìš”í•œ ë¶€ë¶„ë§Œ ë‹´ë‹¹
 *
 * ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ì´ˆê¸° ë°ì´í„°ë¥¼ ìŠ¤í† ì–´ì— ì„¤ì •í•˜ê³ ,
 * ì‚¬ìš©ì ìƒí˜¸ì‘ìš©(ìƒˆë¡œê³ ì¹¨, ì—ëŸ¬ ì²˜ë¦¬)ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
 * ë¬´í•œìŠ¤í¬ë¡¤ì„ í†µí•´ ë” ë§ì€ CVE ë°ì´í„°ë¥¼ ë¡œë“œí•©ë‹ˆë‹¤.
 *
 * @param props
 * @param props.initialCVEs - ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì´ˆê¸° CVE ë°ì´í„°
 */
export function CVEViewerClient({
  initialCVEs,
  metadata,
}: CVEViewerClientProps) {
  const {
    clearError,
    cves,
    error,
    fetchRecentCVEs,
    hasMore,
    isLoading,
    isLoadingMore,
    lastUpdated,
    loadMoreCVEs,
    resetPagination,
    setInitialData,
  } = useCVEStore();

  // ===== ì´ˆê¸° ë°ì´í„° ì„¤ì • =====
  useEffect(() => {
    // ì´ˆê¸° ë©”íƒ€ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìµœì‹ ìˆœ ë°ì´í„° ì¡°íšŒ
    if (metadata) {
      handleRefresh();
    } else if (initialCVEs.length > 0) {
      // ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìŠ¤í† ì–´ì— ì„¤ì •
      setInitialData(initialCVEs, null);
    }
  }, [initialCVEs, metadata, setInitialData, fetchRecentCVEs]);

  // ===== ë¬´í•œìŠ¤í¬ë¡¤ ì„¤ì • =====
  const loadingRef = useInfiniteScroll({
    hasMore,
    isLoading: isLoadingMore,
    onLoadMore: loadMoreCVEs,
    threshold: 200,
  });

  // ===== ë¬´í•œìŠ¤í¬ë¡¤ ë””ë²„ê¹… =====
  useEffect(() => {
    console.log('ğŸ” CVE Viewer mounted:', {
      hasMore,
      isLoadingMore,
      cvesLength: cves.length,
    });
  }, [hasMore, isLoadingMore, cves.length]);

  // ===== ìŠ¤ë‚µë°” í›… ì‚¬ìš© =====
  const { showSnackbar } = useSnackbar();

  // ===== ì—ëŸ¬ ì²˜ë¦¬ =====
  useEffect(() => {
    if (error) {
      showSnackbar({
        message: 'NVD ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
        type: 'error',
        position: 'bottom-right',
        autoHideDuration: 6000,
      });
    }
  }, [error, showSnackbar]);

  // ===== ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ =====
  const handleRefresh = () => {
    clearError();
    resetPagination();

    console.log('ğŸ” metadata', metadata);

    // ì—­ìˆœ í˜ì´ì§€ë„¤ì´ì…˜: ì´ í˜ì´ì§€ ìˆ˜ ê³„ì‚°
    const totalPages = Math.ceil((metadata.totalResults || 1) / 50);
    fetchRecentCVEs({ page: totalPages });
  };

  return (
    <>
      {/* ===== ìƒí˜¸ì‘ìš©ì´ í•„ìš”í•œ ë¶€ë¶„ ===== */}
      <div className="flex flex-col items-start gap-2 mb-4 md:!flex-row md:!items-end md:!gap-4">
        <ActionButton
          feedbackText={isLoading ? 'ë¡œë”© ì¤‘...' : 'ìƒˆë¡œê³ ì¹¨'}
          onClick={handleRefresh}
          variant="primary"
        >
          ìƒˆë¡œê³ ì¹¨
        </ActionButton>

        {lastUpdated && (
          <span className="text-sm text-gray-400">
            ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: {new Date(lastUpdated).toLocaleString('ko-KR')}
          </span>
        )}
      </div>

      {/* ===== CVE ë°ì´í„° ëª©ë¡ ===== */}
      {isLoading && cves.length === 0 ? (
        // ì´ˆê¸° ë¡œë”© ì¤‘ì´ê³  ë°ì´í„°ê°€ ì—†ì„ ë•Œ ìŠ¤ì¼ˆë ˆí†¤ í‘œì‹œ
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {Array.from({ length: 6 }, (_, i) => (
            <CVECardSkeleton key={`skeleton-${i}`} />
          ))}
        </div>
      ) : cves.length > 0 ? (
        // ë°ì´í„°ê°€ ìˆì„ ë•Œ CVE ì¹´ë“œ ëª©ë¡ í‘œì‹œ
        <>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {cves.map((cve) => (
              <CVECard
                key={`${cve.id}-${cve.publishedDate}-${cve.lastModifiedDate || Date.now()}`}
                cve={cve}
              />
            ))}
          </div>

          {/* ===== ë¬´í•œìŠ¤í¬ë¡¤ ë¡œë”© ì˜ì—­ ===== */}
          <div className="mt-6 flex justify-center py-8" ref={loadingRef}>
            {hasMore ? (
              isLoadingMore ? (
                <div className="flex items-center gap-2 text-gray-400">
                  <div className="w-4 h-4 border-2 border-gray-600 border-t-blue-400 rounded-full animate-spin" />
                  <span>ë” ë§ì€ CVE ë¡œë”© ì¤‘...</span>
                </div>
              ) : (
                <div className="h-8" />
              )
            ) : (
              <div className="text-center text-gray-400 py-4">
                ëª¨ë“  CVE ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.
              </div>
            )}
          </div>
        </>
      ) : (
        // ë°ì´í„°ê°€ ì—†ì„ ë•Œ ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        <div className="text-center py-12">
          <p className="text-gray-400">í‘œì‹œí•  CVE ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      )}
    </>
  );
}

'use client';

import { ActionButton } from '@repo/ui';
import { useCVEStore } from '@store/cve-store';
import Link from 'next/link';
import React, { useEffect } from 'react';

import { CVECard } from './components/cve-card';
import CVECardSkeleton from './components/cve-card-skeleton';

export default function CVETrackerPage() {
  const { clearError, cves, error, fetchRecentCVEs, isLoading, lastUpdated } =
    useCVEStore();

  useEffect(() => {
    fetchRecentCVEs();
  }, [fetchRecentCVEs]);

  const handleRefresh = () => {
    clearError();
    fetchRecentCVEs();
  };

  return (
    <div className="flex flex-col min-h-fit h-full p-8">
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-blue-400 mb-2">
          CVE 취약점 추적기
        </h1>
        <p className="text-gray-400 mb-4">
          NVD(National Vulnerability Database)에서 최근 CVE 취약점 정보를
          실시간으로 확인할 수 있습니다.
        </p>

        <div className="mt-4 flex items-center gap-3 p-4 bg-gray-800/90 border border-gray-600 rounded-lg shadow mb-4">
          <span className="text-2xl">💡</span>
          <span className="text-sm text-gray-200">
            <strong>CVE와 CPE에 대해 더 알고싶다면?</strong>{' '}
            <Link
              className="underline text-blue-400 hover:text-blue-300 font-semibold"
              href="https://nvd.nist.gov/vuln/data-feeds"
              rel="noopener noreferrer"
              target="_blank"
            >
              NVD 공식 문서
            </Link>
            에서 더 많은 정보와 API 사용법을 확인할 수 있습니다.
          </span>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div className="p-4 bg-gray-800/50 border border-gray-700 rounded-lg">
            <h3 className="text-lg font-semibold text-blue-400 mb-2">
              CVE (Common Vulnerabilities and Exposures)
            </h3>
            <p className="text-sm text-gray-300 mb-2">
              보안 취약점을 식별하고 분류하기 위한 표준화된 명명 체계입니다.
            </p>
            <ul className="text-xs text-gray-400 space-y-1">
              <li>• 고유 식별자: CVE-2024-1234 형태</li>
              <li>• 중앙 집중식 데이터베이스 관리</li>
              <li>• 표준화된 취약점 정보 제공</li>
              <li>• 국제 보안 커뮤니티 표준</li>
            </ul>
          </div>

          <div className="p-4 bg-gray-800/50 border border-gray-700 rounded-lg">
            <h3 className="text-lg font-semibold text-green-400 mb-2">
              CPE (Common Platform Enumeration)
            </h3>
            <p className="text-sm text-gray-300 mb-2">
              IT 제품과 플랫폼을 표준화된 방식으로 명명하는 체계입니다.
            </p>
            <ul className="text-xs text-gray-400 space-y-1">
              <li>• 제품 식별: cpe:2.3:a:microsoft:windows:10:*</li>
              <li>• 구조화된 형식으로 제품 정보 표현</li>
              <li>• CVE와 영향받는 제품 연결</li>
              <li>• 보안 도구 자동화 지원</li>
            </ul>
          </div>
        </div>

        <div className="flex items-center gap-4 mb-4">
          <ActionButton
            feedbackText={isLoading ? '로딩 중...' : '새로고침'}
            onClick={handleRefresh}
            variant="primary"
          >
            새로고침
          </ActionButton>

          {lastUpdated && (
            <span className="text-sm text-gray-400">
              마지막 업데이트: {new Date(lastUpdated).toLocaleString('ko-KR')}
            </span>
          )}
        </div>

        {error && (
          <div className="mb-4 p-4 bg-red-900/20 border border-red-700 rounded-lg">
            <p className="text-red-400">오류: {error}</p>
          </div>
        )}
      </div>

      <div className="flex-1 overflow-auto">
        {isLoading && cves.length === 0 ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {Array.from({ length: 6 }, (_, i) => (
              <CVECardSkeleton key={`skeleton-${i}`} />
            ))}
          </div>
        ) : cves.length > 0 ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {cves.map((cve) => (
              <CVECard key={cve.id} cve={cve} />
            ))}
          </div>
        ) : (
          <div className="text-center py-12">
            <p className="text-gray-400">표시할 CVE 데이터가 없습니다.</p>
          </div>
        )}
      </div>
    </div>
  );
}
